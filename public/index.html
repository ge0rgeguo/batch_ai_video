<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIè§†é¢‘æ‰¹é‡ç”Ÿæˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
    .container { max-width: 1400px; margin: 0 auto; }
    
    /* ç™»å½•é¡µé¢ - çºµå‘å¸ƒå±€ */
    .login-container { display: flex; justify-content: center; align-items: center; min-height: 80vh; }
    .login-card { background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 48px; width: 100%; max-width: 420px; }
    .login-card h1 { font-size: 28px; margin-bottom: 32px; text-align: center; color: #667eea; }
    .login-card .form-group { margin-bottom: 24px; display: flex; flex-direction: column; }
    .login-card label { font-weight: 600; margin-bottom: 8px; color: #555; }
    .login-card input { padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s; }
    .login-card input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .login-card button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top: 8px; }
    .login-card button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
    .login-card .error-msg { color: #e53e3e; font-size: 14px; margin-top: 16px; text-align: center; padding: 12px; background: #fff5f5; border-radius: 6px; display: none; }
    
    header { background: white; border-radius: 16px; padding: 24px 32px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    header h1 { font-size: 28px; color: #667eea; }
    header .user-info { display: flex; align-items: center; gap: 16px; }
    header button { padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
    header button:hover { background: #5568d3; transform: translateY(-1px); }
    
    .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
    .card h3 { font-size: 18px; margin-bottom: 16px; color: #667eea; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; }
    
    /* Promptæ–‡æœ¬æ¡† - å¯è‡ªé€‚åº”å‚ç›´è°ƒæ•´ */
    textarea#prompt { width: 100%; min-height: 120px; max-height: 400px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; }
    textarea#prompt:focus { outline: none; border-color: #667eea; }
    
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px; }
    label { display: block; font-weight: 600; margin-bottom: 6px; color: #555; }
    input, select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #667eea; }
    
    button { padding: 12px 24px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.3s; }
    button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
    button.secondary { background: #718096; }
    button.secondary:hover { background: #4a5568; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    thead { background: #f7fafc; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { font-weight: 600; color: #667eea; }
    
    .status-pending, .status-queued { color: #ed8936; font-weight: 600; }
    .status-running { color: #3182ce; font-weight: 600; }
    .status-completed { color: #38a169; font-weight: 600; }
    .status-failed { color: #e53e3e; font-weight: 600; }
    .status-cancelled { color: #718096; font-weight: 600; }
    
    .action-btn { padding: 6px 12px; font-size: 13px; margin-right: 6px; }
    
    .hidden { display: none !important; }
    
    #thumb { margin-top: 12px; border: 2px solid #e0e0e0; }
    /* å››åˆ—å¸ƒå±€ - ç»Ÿä¸€é«˜åº¦ */
    .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1.2fr; gap: 16px; align-items: stretch; margin-bottom: 16px; }
    @media (max-width: 1200px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 700px) { .grid-4 { grid-template-columns: 1fr; } }
    .card.compact { padding: 20px; display: flex; flex-direction: column; height: 100%; }
    .card.compact h3 { margin-bottom: 16px; flex-shrink: 0; }
    .card.compact > *:not(h3) { flex-grow: 0; }
    .card.compact table { flex-grow: 1; }
    
    /* ä¸Šä¼ åˆ—æ ·å¼ */
    #col-upload input[type="file"] { margin-bottom: 12px; padding: 8px; border: 2px dashed #cbd5e0; border-radius: 8px; background: #f7fafc; cursor: pointer; }
    #col-upload #thumb { max-width: 100%; max-height: 280px; object-fit: contain; margin: 12px 0; border-radius: 8px; }
    #col-upload button { margin-top: auto; }
    
    /* Promptåˆ—æ ·å¼ */
    #col-prompt textarea { flex-grow: 1; min-height: 200px; max-height: 400px; }
    
    /* å‚æ•°è®¾ç½®åˆ—æ ·å¼ */
    #col-settings .row { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; }
    #col-settings .row label { display: flex; flex-direction: column; gap: 6px; font-weight: 600; font-size: 14px; color: #555; }
    #col-settings .row select, #col-settings .row input { padding: 10px; }
    #col-settings button { margin-top: auto; width: 100%; padding: 14px; font-size: 16px; }
    
    /* æ‰¹æ¬¡åˆ—è¡¨åˆ—æ ·å¼ */
    #col-batches { overflow: hidden; }
    #col-batches table { font-size: 13px; }
    #col-batches th, #col-batches td { padding: 10px 8px; }
    #batches-pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0; }
    #batches-pagination button { padding: 8px 14px; font-size: 13px; }
    
    .prompt-box { border: 1px dashed #e2e8f0; background: #f9fafb; padding: 10px; border-radius: 8px; white-space: pre-wrap; word-break: break-word; max-height: 140px; overflow: auto; font-size: 13px; color:#2d3748; }
    
    /* Toast æç¤º */
    #toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: white; color: #2d3748; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: 500; animation: slideIn 0.3s ease-out; min-width: 280px; }
    .toast.success { border-left: 4px solid #38a169; }
    .toast.error { border-left: 4px solid #e53e3e; }
    .toast.info { border-left: 4px solid #3182ce; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
    .toast.hiding { animation: slideOut 0.3s ease-in forwards; }
  </style>
</head>
<body>

<div id="toast-container"></div>

<!-- ç™»å½•ç•Œé¢ -->
<div id="login-container" class="login-container">
  <div class="login-card">
    <h1>ğŸ¬ AIè§†é¢‘ç”Ÿæˆå¹³å°</h1>
    <div class="form-group">
      <label>ç”¨æˆ·å</label>
      <input type="text" id="login-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
    </div>
    <div class="form-group">
      <label>å¯†ç </label>
      <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç " />
    </div>
    <button onclick="handleLogin()">ç™»å½•</button>
    <div class="error-msg" id="login-error"></div>
  </div>
</div>

<!-- ä¸»åº”ç”¨ç•Œé¢ -->
<div id="app-container" class="container hidden">
  <header>
    <h1>ğŸ¬ AIè§†é¢‘æ‰¹é‡ç”Ÿæˆ</h1>
    <div class="user-info">
      <span id="user-display"></span>
      <span id="user-credits" style="color:#2d3748;font-weight:600;"></span>
      <button onclick="handleLogout()">é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <div class="grid-4">
    <div class="card compact" id="col-upload">
      <h3>1) ä¸Šä¼ å›¾ç‰‡</h3>
      <input type="file" id="image-file" accept="image/png, image/jpeg" />
      <img id="thumb" style="display: none;" />
      <button class="secondary" id="remove-img" style="display:none;">åˆ é™¤å›¾ç‰‡</button>
    </div>

    <div class="card compact" id="col-prompt">
      <h3>2) Prompt</h3>
      <textarea id="prompt" placeholder="è¯·è¾“å…¥ prompt (å¿…å¡«ï¼Œâ‰¤3000 å­—)"></textarea>
    </div>

    <div class="card compact" id="col-settings">
      <h3>3) å‚æ•°è®¾ç½®</h3>
      <div class="row">
        <label>æ¨¡å‹
          <select id="model"><option value="sora-2">Sora 2</option></select>
        </label>
        <label>æ–¹å‘
          <select id="orientation"><option value="landscape">æ¨ªå‘</option><option value="portrait">çºµå‘</option></select>
        </label>
        <label>å°ºå¯¸
          <select id="size"><option value="small">å°</option><option value="medium">ä¸­</option></select>
        </label>
        <label>æ—¶é•¿
          <select id="duration"><option value="5">5ç§’</option><option value="10">10ç§’</option></select>
        </label>
        <label>è§†é¢‘æ•°é‡
          <input type="number" id="num-videos" value="1" min="1" max="50" />
        </label>
      </div>
      <div style="margin:8px 0 12px 0;color:#4a5568;font-size:13px;">
        æ¯ä¸ªè§†é¢‘æ¶ˆè€—ï¼š10ç§’ 15åˆ†ï¼›5ç§’ 8åˆ†
      </div>
      <button onclick="createBatch()">åˆ›å»ºæ‰¹æ¬¡</button>
    </div>

    <div class="card compact" id="col-batches">
      <h3>4) æ‰¹æ¬¡åˆ—è¡¨ <span style="font-size:13px;color:#718096;">(è‡ªåŠ¨åˆ·æ–°)</span></h3>
      <table id="batch-table">
        <thead>
          <tr>
            <th>æ‰¹æ¬¡ID</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="batches-pagination">
        <button class="secondary" onclick="prevBatchPage()">ä¸Šä¸€é¡µ</button>
        <div id="batches-page-info" style="font-size:13px;color:#718096;">ç¬¬ 1 / 1 é¡µ</div>
        <button class="secondary" onclick="nextBatchPage()">ä¸‹ä¸€é¡µ</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>5) ä»»åŠ¡ç»“æœ <span id="task-batch-id"></span></h3>
    <div style="margin-bottom: 12px;">
      <button onclick="retryFailedTasks()" class="secondary">ä¸€é”®é‡è¯•å¤±è´¥</button>
      <button onclick="downloadBatchZip()" class="secondary">ä¸‹è½½ ZIP</button>
    </div>
    <table id="task-table">
      <thead>
        <tr>
          <th>ä»»åŠ¡ID</th>
          <th>çŠ¶æ€</th>
          <th>ç»“æœ</th>
          <th>Prompt</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
let currentUser = null;
let currentBatchId = null;
let uploadedImagePath = null;
let autoRefreshInterval = null;

// çŠ¶æ€æ ‡ç­¾æ˜ å°„
const statusLabels = {
  pending: 'ç­‰å¾…ä¸­',
  queued: 'æ’é˜Ÿä¸­',
  running: 'è¿›è¡Œä¸­',
  completed: 'å·²å®Œæˆ',
  failed: 'å¤±è´¥',
  cancelled: 'å·²å–æ¶ˆ'
};

// Toast æç¤ºå‡½æ•°
function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹';
  toast.innerHTML = `<span style="font-size:20px;">${icon}</span><span>${message}</span>`;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('hiding');
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}

// åˆå§‹åŒ–æ£€æŸ¥ç™»å½•çŠ¶æ€
(async function init() {
  try {
    const resp = await fetch('/api/me');
    const json = await resp.json();
    if (json.ok) {
      currentUser = json.data;
      showApp();
    } else {
      showLogin();
    }
  } catch {
    showLogin();
  }
})();

function showLogin() {
  document.getElementById('login-container').classList.remove('hidden');
  document.getElementById('app-container').classList.add('hidden');
}

function showApp() {
  document.getElementById('login-container').classList.add('hidden');
  document.getElementById('app-container').classList.remove('hidden');
  document.getElementById('user-display').textContent = `ğŸ‘¤ ${currentUser.username}`;
  document.getElementById('user-credits').textContent = `ğŸ’ ä½™é¢ï¼š${currentUser.credits ?? 0}`;
  refreshBatches();
  // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  autoRefreshInterval = setInterval(() => {
    refreshBatches();
    if (currentBatchId) viewTasks(currentBatchId);
  }, 5000);
}

async function handleLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const errorEl = document.getElementById('login-error');
  
  errorEl.style.display = 'none';
  
  if (!username || !password) {
    errorEl.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
    errorEl.style.display = 'block';
    return;
  }
  
  try {
    const resp = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const json = await resp.json();
    
    if (json.ok) {
      // ç™»å½•æˆåŠŸååˆ·æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œç¡®ä¿æ‹¿åˆ°æœ€æ–°ç§¯åˆ†
      const meResp = await fetch('/api/me');
      const meJson = await meResp.json();
      if (meJson.ok) {
        currentUser = meJson.data;
      } else {
        currentUser = json.data;
      }
      showApp();
    } else {
      errorEl.textContent = json.error.message || 'ç™»å½•å¤±è´¥';
      errorEl.style.display = 'block';
    }
  } catch (err) {
    errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
    errorEl.style.display = 'block';
  }
}

async function handleLogout() {
  await fetch('/api/logout', { method: 'POST' });
  currentUser = null;
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  showLogin();
}

// å›¾ç‰‡ä¸Šä¼ 
document.getElementById('image-file').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const formData = new FormData();
  formData.append('file', file);
  
  const resp = await fetch('/api/images/upload', { method: 'POST', body: formData });
  const json = await resp.json();
  
  if (json.ok) {
    uploadedImagePath = json.data.path;
    const thumb = document.getElementById('thumb');
    const removeBtn = document.getElementById('remove-img');
    thumb.src = URL.createObjectURL(file);
    thumb.style.display = 'block';
    removeBtn.style.display = 'block';
    showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
  } else {
    showToast(json.error.message, 'error');
  }
});

document.getElementById('remove-img').addEventListener('click', async () => {
  if (!uploadedImagePath) return;
  
  const resp = await fetch('/api/images?image_path=' + encodeURIComponent(uploadedImagePath), { method: 'DELETE' });
  const json = await resp.json();
  
  if (json.ok) {
    uploadedImagePath = null;
    document.getElementById('thumb').style.display = 'none';
    document.getElementById('remove-img').style.display = 'none';
    document.getElementById('image-file').value = '';
    showToast('å›¾ç‰‡å·²åˆ é™¤', 'success');
  }
});

// åˆ›å»ºæ‰¹æ¬¡
async function createBatch() {
  const prompt = document.getElementById('prompt').value.trim();
  if (!prompt) {
    alert('è¯·è¾“å…¥ prompt');
    return;
  }
  // å¹³å°å¯†é’¥ä»…ç”±åç«¯/ç®¡ç†å‘˜é…ç½®ï¼Œä¸åœ¨å‰ç«¯æç¤ºæˆ–æ”¶é›†
  
  const req = {
    prompt,
    model: document.getElementById('model').value,
    orientation: document.getElementById('orientation').value,
    size: document.getElementById('size').value,
    duration: parseInt(document.getElementById('duration').value),
    num_videos: parseInt(document.getElementById('num-videos').value),
    image_path: uploadedImagePath
  };
  
  const idempotencyKey = `${Date.now()}-${Math.random()}`;
  const resp = await fetch('/api/batches', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Idempotency-Key': idempotencyKey
    },
    body: JSON.stringify(req)
  });
  const json = await resp.json();
  if (json.ok) {
    showToast('æ‰¹æ¬¡åˆ›å»ºæˆåŠŸ', 'success');
    refreshBatches();
    // æ‰£å‡ç§¯åˆ†ååˆ·æ–°å±•ç¤º
    try {
      const meResp = await fetch('/api/me');
      const meJson = await meResp.json();
      if (meJson.ok) {
        currentUser = meJson.data;
        document.getElementById('user-credits').textContent = `ğŸ’ ä½™é¢ï¼š${currentUser.credits ?? 0}`;
      }
    } catch {}
  } else {
    if (json.error && json.error.code === 'INSUFFICIENT_CREDITS') {
      showToast('ç§¯åˆ†ä¸è¶³ï¼Œè¯·å……å€¼åå†è¯•', 'error');
    } else {
      showToast(json.error?.message || 'åˆ›å»ºå¤±è´¥', 'error');
    }
  }
}

// åˆ·æ–°æ‰¹æ¬¡åˆ—è¡¨
let batchPage = 1;
let batchTotalPages = 1;
const BATCHES_PER_PAGE = 5;

async function refreshBatches() {
  const resp = await fetch(`/api/batches?page=${batchPage}&page_size=${BATCHES_PER_PAGE}`);
  const json = await resp.json();
  
  if (!json.ok) return;
  const data = json.data;
  batchTotalPages = data.total_pages || 1;
  const pageInfo = document.getElementById('batches-page-info');
  if (pageInfo) pageInfo.textContent = `ç¬¬ ${data.page} / ${batchTotalPages} é¡µ`;
  
  const tbody = document.querySelector('#batch-table tbody');
  tbody.innerHTML = '';
  
  (data.items || []).forEach(batch => {
    const tr = document.createElement('tr');
    let statusLabel = '';
    let statusColor = '#718096';
    
    if (batch.running > 0 || batch.queued > 0) {
      statusLabel = 'ğŸ”„ è¿›è¡Œä¸­';
      statusColor = '#3182ce';
    } else if (batch.failed > 0) {
      statusLabel = 'âŒ éƒ¨åˆ†å¤±è´¥';
      statusColor = '#e53e3e';
    } else if (batch.completed === batch.total && batch.total > 0) {
      statusLabel = 'âœ… å…¨éƒ¨å®Œæˆ';
      statusColor = '#38a169';
    } else {
      statusLabel = 'å¾…å¯åŠ¨';
    }
    
    const statusText = `<span style="color:${statusColor};font-weight:600;">${statusLabel}</span><br><small style="color:#718096;">æ€»:${batch.total} å®Œæˆ:${batch.completed} å¤±è´¥:${batch.failed} è¿›è¡Œ:${batch.running} æ’é˜Ÿ:${batch.queued}</small>`;
    
    tr.innerHTML = `
      <td>${batch.id.substring(0, 8)}...</td>
      <td>${statusText}</td>
      <td>
        <button class="action-btn secondary" onclick="viewTasks('${batch.id}')">æŸ¥çœ‹ä»»åŠ¡</button>
        <button class="action-btn secondary" onclick="deleteBatch('${batch.id}')">åˆ é™¤</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function prevBatchPage() { if (batchPage > 1) { batchPage--; refreshBatches(); } }
function nextBatchPage() { if (batchPage < batchTotalPages) { batchPage++; refreshBatches(); } }

// æŸ¥çœ‹ä»»åŠ¡
async function viewTasks(batchId) {
  currentBatchId = batchId;
  document.getElementById('task-batch-id').textContent = `(æ‰¹æ¬¡: ${batchId.substring(0, 8)}...)`;
  
  const resp = await fetch(`/api/batches/${batchId}/tasks`);
  const json = await resp.json();
  
  if (!json.ok) return;
  
  const tbody = document.querySelector('#task-table tbody');
  tbody.innerHTML = '';
  
  json.data.forEach(task => {
    const tr = document.createElement('tr');
    const statusClass = `status-${task.status}`;
    const statusText = statusLabels[task.status] || task.status;
    
    let resultCell = '-';
    if (task.status === 'completed' && task.result_path) {
      const fname = task.result_path.split('/').pop();
      resultCell = `<a href="${task.result_path}" target="_blank">${fname}</a>`;
    }
    
    tr.innerHTML = `
      <td>${task.id.substring(0, 8)}...</td>
      <td class="${statusClass}">${statusText}</td>
      <td>${resultCell}</td>
      <td><div class="prompt-box">${(task.prompt || '').replace(/</g,'&lt;')}</div></td>
      <td>
        ${task.status === 'failed' ? `<button class="action-btn" onclick="retryTask('${task.id}')">é‡è¯•</button>` : ''}
        ${['pending','queued','running'].includes(task.status) ? `<button class="action-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>` : ''}
        <button class="action-btn secondary" onclick="deleteTask('${task.id}')">åˆ é™¤</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ä»»åŠ¡æ“ä½œ
async function retryTask(taskId) {
  const resp = await fetch(`/api/tasks/${taskId}/retry`, { method: 'POST' });
  const json = await resp.json();
  if (json.ok) {
    alert('ä»»åŠ¡å·²é‡æ–°æäº¤');
    viewTasks(currentBatchId);
  } else {
    alert(json.error.message);
  }
}

async function cancelTask(taskId) {
  const resp = await fetch(`/api/tasks/${taskId}/cancel`, { method: 'POST' });
  const json = await resp.json();
  if (json.ok) {
    alert('ä»»åŠ¡å·²å–æ¶ˆ');
    viewTasks(currentBatchId);
  } else {
    alert(json.error.message);
  }
}

async function deleteTask(taskId) {
  if (!confirm('ç¡®è®¤åˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ')) return;
  const resp = await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
  const json = await resp.json();
  if (json.ok) {
    viewTasks(currentBatchId);
    refreshBatches();
  }
}

async function deleteBatch(batchId) {
  if (!confirm('ç¡®è®¤åˆ é™¤æ•´ä¸ªæ‰¹æ¬¡ï¼Ÿ')) return;
  const resp = await fetch(`/api/batches/${batchId}`, { method: 'DELETE' });
  const json = await resp.json();
  if (json.ok) {
    alert('æ‰¹æ¬¡å·²åˆ é™¤');
    refreshBatches();
    if (currentBatchId === batchId) {
      currentBatchId = null;
      document.querySelector('#task-table tbody').innerHTML = '';
    }
  }
}

// å·²ç§»é™¤å‰ç«¯API Keyæ“ä½œï¼šå¯†é’¥ç”±åç«¯å®‰å…¨é…ç½®

// æ‰¹é‡æ“ä½œ
async function retryFailedTasks() {
  if (!currentBatchId) {
    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰¹æ¬¡');
    return;
  }
  
  const resp = await fetch(`/api/batches/${currentBatchId}/tasks`);
  const json = await resp.json();
  if (!json.ok) return;
  
  const failedTasks = json.data.filter(t => t.status === 'failed');
  if (failedTasks.length === 0) {
    alert('æ²¡æœ‰å¤±è´¥çš„ä»»åŠ¡');
    return;
  }
  
  for (const task of failedTasks) {
    await fetch(`/api/tasks/${task.id}/retry`, { method: 'POST' });
  }
  
  alert(`å·²é‡è¯• ${failedTasks.length} ä¸ªå¤±è´¥ä»»åŠ¡`);
  viewTasks(currentBatchId);
}

function downloadBatchZip() {
  if (!currentBatchId) {
    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰¹æ¬¡');
    return;
  }
  window.location.href = `/api/batches/${currentBatchId}/download`;
}
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIè§†é¢‘æ‰¹é‡ç”Ÿæˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
    .container { max-width: 1600px; margin: 0 auto; }
    
    /* ç™»å½•é¡µé¢ */
    .login-container { display: flex; justify-content: center; align-items: center; min-height: 80vh; }
    .login-card { background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 48px; width: 100%; max-width: 420px; }
    .login-card h1 { font-size: 28px; margin-bottom: 32px; text-align: center; color: #667eea; }
    .login-card .form-group { margin-bottom: 24px; display: flex; flex-direction: column; }
    .login-card label { font-weight: 600; margin-bottom: 8px; color: #555; }
    .login-card input { padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s; }
    .login-card input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .login-card button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top: 8px; }
    .login-card button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
    .login-card .error-msg { color: #e53e3e; font-size: 14px; margin-top: 16px; text-align: center; padding: 12px; background: #fff5f5; border-radius: 6px; display: none; }
    
    /* Header */
    header { background: white; border-radius: 16px; padding: 24px 32px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    header h1 { font-size: 28px; color: #667eea; }
    header .user-info { display: flex; align-items: center; gap: 16px; }
    header button { padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
    header button:hover { background: #5568d3; transform: translateY(-1px); }
    
    /* Card */
    .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
    .card h3 { font-size: 18px; margin-bottom: 16px; color: #667eea; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; }
    
    /* ä¸‰æ å¸ƒå±€ - ä¿®æ”¹1: å‡åˆ†æ å®½ï¼Œæ·»åŠ åˆ†éš”çº¿ */
    .three-col-layout { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0; margin-bottom: 16px; }
    .three-col-layout > div { padding: 0 20px; }
    .three-col-layout > div:not(:last-child) { border-right: 2px solid #e2e8f0; }
    @media (max-width: 1200px) { 
      .three-col-layout { grid-template-columns: 1fr; } 
      .three-col-layout > div:not(:last-child) { border-right: none; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 20px; }
    }
    
    /* å›¾ç‰‡ä¸Šä¼ åˆ— */
    .col-image { display: flex; flex-direction: column; }
    .col-image input[type="file"] { margin-bottom: 12px; padding: 8px; border: 2px dashed #cbd5e0; border-radius: 8px; background: #f7fafc; cursor: pointer; font-size: 14px; }
    .col-image #thumb { max-width: 100%; max-height: 250px; object-fit: contain; margin: 12px 0; border-radius: 8px; border: 2px solid #e0e0e0; }
    .col-image button.remove-btn { margin-top: auto; background: #718096; }
    
    /* Promptåˆ— */
    .col-prompt textarea { width: 100%; min-height: 280px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; }
    .col-prompt textarea:focus { outline: none; border-color: #667eea; }
    
    /* å‚æ•°è®¾ç½®åˆ— */
    .col-params .param-group { margin-bottom: 16px; }
    .col-params label { display: block; font-weight: 600; margin-bottom: 6px; color: #555; font-size: 14px; }
    .col-params select, .col-params input { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
    .col-params select:focus, .col-params input:focus { outline: none; border-color: #667eea; }
    
    /* ç”ŸæˆæŒ‰é’® - ä¿®æ”¹2: çœŸæ­£æ¨ªè·¨æ•´ä¸ªå®½åº¦ */
    .generate-btn-container { margin-bottom: 0; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0; }
    .generate-btn { width: 100%; padding: 18px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 18px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
    .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5); }
    
    /* è¡¨æ ¼æ ·å¼ */
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    thead { background: #f7fafc; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { font-weight: 600; color: #667eea; font-size: 14px; }
    td { font-size: 14px; color: #2d3748; }
    
    /* ä¸€çº§è¡¨æ ¼è¡Œæ ·å¼ */
    .batch-row { cursor: pointer; transition: background 0.2s; }
    .batch-row:hover { background: #f7fafc; }
    .batch-row.expanded { background: #edf2f7; }
    
    /* äºŒçº§è¡¨æ ¼æ ·å¼ */
    .tasks-detail-row { background: #f9fafb; }
    .tasks-detail-cell { padding: 0 !important; }
    .tasks-inner-container { padding: 16px 24px; border-left: 4px solid #667eea; }
    .tasks-actions { margin-bottom: 12px; display: flex; gap: 8px; }
    .tasks-table { margin: 0; background: white; border-radius: 8px; overflow: hidden; }
    .tasks-table th { background: #edf2f7; }
    
    /* çŠ¶æ€æ ·å¼ */
    .status-pending, .status-queued { color: #ed8936; font-weight: 600; }
    .status-running { color: #3182ce; font-weight: 600; }
    .status-completed { color: #38a169; font-weight: 600; }
    .status-failed { color: #e53e3e; font-weight: 600; }
    .status-cancelled { color: #718096; font-weight: 600; }
    
    /* æŒ‰é’® */
    button { padding: 8px 16px; border: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s; }
    button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    button.secondary { background: #718096; }
    button.secondary:hover { background: #4a5568; box-shadow: 0 4px 12px rgba(74, 85, 104, 0.4); }
    button.danger { background: #e53e3e; }
    button.danger:hover { background: #c53030; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* ç¼©ç•¥å›¾ç‰‡ */
    .thumb-small { max-width: 60px; max-height: 60px; border-radius: 4px; object-fit: cover; }
    
    /* æç¤ºè¯é¢„è§ˆæ¡† - ä¿®æ”¹3: ä¼˜åŒ–æ˜¾ç¤ºå’Œæ‚¬æµ®æç¤º */
    .prompt-preview { 
      max-width: 100%; 
      max-height: 60px; 
      overflow: hidden; 
      font-size: 12px; 
      color: #4a5568; 
      line-height: 1.5; 
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      word-break: break-all;
      background: #f9fafb; 
      padding: 8px; 
      border-radius: 4px; 
      border: 1px solid #e2e8f0; 
      cursor: help;
      position: relative;
    }
    .prompt-preview:hover { 
      background: #edf2f7; 
      overflow: visible;
      z-index: 10;
      position: absolute;
      max-height: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 400px;
    }
    
    /* Toast */
    #toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: white; color: #2d3748; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: 500; animation: slideIn 0.3s ease-out; min-width: 280px; }
    .toast.success { border-left: 4px solid #38a169; }
    .toast.error { border-left: 4px solid #e53e3e; }
    .toast.info { border-left: 4px solid #3182ce; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
    .toast.hiding { animation: slideOut 0.3s ease-in forwards; }
    
    .hidden { display: none !important; }
    
    /* å±•å¼€/æ”¶èµ·å›¾æ ‡ - ä¿®æ”¹7: ä¿®å¤æ˜¾ç¤ºé—®é¢˜ */
    .expand-icon { display: inline-block; transition: transform 0.3s; margin-right: 4px; color: #667eea; font-weight: bold; font-size: 12px; }
    .expand-icon.expanded { transform: rotate(90deg); }
    
    /* ä¿®æ”¹6: æ“ä½œåˆ—æŒ‰é’®æ¨ªå‘å¸ƒå±€ */
    .action-buttons { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .action-buttons button { white-space: nowrap; font-size: 12px; padding: 6px 10px; }
    
    /* åˆ†é¡µ */
    .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
  </style>
</head>
<body>

<div id="toast-container"></div>

<!-- ç™»å½•ç•Œé¢ -->
<div id="login-container" class="login-container">
  <div class="login-card">
    <h1>ğŸ¬ AIè§†é¢‘ç”Ÿæˆå¹³å°</h1>
    <div class="form-group">
      <label>ç”¨æˆ·å</label>
      <input type="text" id="login-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
    </div>
    <div class="form-group">
      <label>å¯†ç </label>
      <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç " />
    </div>
    <button onclick="handleLogin()">ç™»å½•</button>
    <div class="error-msg" id="login-error"></div>
  </div>
</div>

<!-- ä¸»åº”ç”¨ç•Œé¢ -->
<div id="app-container" class="container hidden">
  <header>
    <h1>ğŸ¬ AIè§†é¢‘æ‰¹é‡ç”Ÿæˆ</h1>
    <div class="user-info">
      <span id="user-display"></span>
      <span id="user-credits" style="color:#2d3748;font-weight:600;"></span>
      <button onclick="handleLogout()">é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šä¸‰æ å¸ƒå±€ -->
  <div class="card">
    <div class="three-col-layout">
      <!-- å·¦æ ï¼šå›¾ç‰‡ -->
      <div class="col-image">
        <h3 style="margin-bottom: 12px;">å›¾ç‰‡</h3>
        <input type="file" id="image-file" accept="image/png, image/jpeg" />
        <img id="thumb" style="display: none;" />
        <button class="secondary remove-btn" id="remove-img" style="display:none;">åˆ é™¤å›¾ç‰‡</button>
      </div>
      
      <!-- ä¸­æ ï¼šæç¤ºè¯ -->
      <div class="col-prompt">
        <h3 style="margin-bottom: 12px;">æç¤ºè¯ Prompt</h3>
        <textarea id="prompt" placeholder="è¯·è¾“å…¥è§†é¢‘ç”Ÿæˆæç¤ºè¯ï¼ˆå¿…å¡«ï¼Œâ‰¤10000å­—ç¬¦ï¼‰"></textarea>
      </div>
      
      <!-- å³æ ï¼šæ¨¡å‹å‚æ•° -->
      <div class="col-params">
        <h3 style="margin-bottom: 12px;">æ¨¡å‹å‚æ•°</h3>
        <div class="param-group">
          <label>æ¨¡å‹</label>
          <select id="model">
            <option value="sora-2">Sora 2</option>
            <option value="sora-2-pro">Sora 2 Pro</option>
          </select>
        </div>
        <div class="param-group">
          <label>æ–¹å‘</label>
          <select id="orientation">
            <option value="landscape">æ¨ªå‘</option>
            <option value="portrait">çºµå‘</option>
          </select>
        </div>
        <div class="param-group">
          <label>å°ºå¯¸</label>
          <select id="size">
            <option value="small">720p</option>
            <option value="large">1080p</option>
          </select>
        </div>
        <div class="param-group">
          <label>æ—¶é•¿</label>
          <select id="duration"></select>
        </div>
        <div class="param-group">
          <label>è§†é¢‘æ•°é‡</label>
          <input type="number" id="num-videos" value="1" min="1" max="50" />
        </div>
      </div>
    </div>
    
    <!-- æ¨ªè·¨ä¸‰æ çš„ç”ŸæˆæŒ‰é’® -->
    <div class="generate-btn-container">
      <button class="generate-btn" onclick="createBatch()">ğŸ¬ ç”Ÿæˆè§†é¢‘</button>
    </div>
  </div>

  <!-- ä¸‹åŠéƒ¨åˆ†ï¼šæ•´åˆçš„æ‰¹æ¬¡/ä»»åŠ¡åˆ—è¡¨ -->
  <div class="card">
    <h3>ä»»åŠ¡ç®¡ç† <span style="font-size:13px;color:#718096;font-weight:normal;">(ç‚¹å‡»è¡ŒæŸ¥çœ‹è¯¦æƒ…)</span></h3>
    
    <table id="batch-table">
      <thead>
        <tr>
          <th style="width:50px;">åºå·</th>
          <th style="width:160px;">åˆ›å»ºæ—¶é—´</th>
          <th style="width:350px;">æç¤ºè¯</th>
          <th style="width:80px;">å›¾ç‰‡</th>
          <th style="width:160px;">çŠ¶æ€</th>
          <th style="width:240px;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    
    <div class="pagination">
      <button class="secondary" onclick="prevPage()">ä¸Šä¸€é¡µ</button>
      <div id="page-info" style="font-size:14px;color:#718096;">ç¬¬ 1 / 1 é¡µ</div>
      <button class="secondary" onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
    </div>
  </div>
</div>

<script>
let currentUser = null;
let uploadedImagePath = null;
let autoRefreshInterval = null;
let currentPage = 1;
let totalPages = 1;
const PAGE_SIZE = 10;
let expandedBatches = new Set(); // è®°å½•å±•å¼€çš„æ‰¹æ¬¡

// çŠ¶æ€æ ‡ç­¾æ˜ å°„
const statusLabels = {
  pending: 'ç­‰å¾…ä¸­',
  queued: 'æ’é˜Ÿä¸­',
  running: 'è¿›è¡Œä¸­',
  completed: 'å·²å®Œæˆ',
  failed: 'å¤±è´¥',
  cancelled: 'å·²å–æ¶ˆ'
};

// æ¨¡å‹é…ç½®
const MODEL_CONFIG = {
  'sora-2': {
    durations: [10, 15],
    allowedSizes: ['small'],
    pricing: {10: 10, 15: 15},
  },
  'sora-2-pro': {
    durations: [10, 15, 25],
    allowedSizes: ['large'],
    pricing: {10: 50, 15: 75, 25: 100},
  },
};

// ä¿®æ”¹3: æ·»åŠ é»˜è®¤å€¼
function updateDurationOptions() {
  const modelSel = document.getElementById('model');
  const durSel = document.getElementById('duration');
  const sizeSel = document.getElementById('size');
  if (!modelSel || !durSel || !sizeSel) return;
  
  const model = modelSel.value;
  const config = MODEL_CONFIG[model] || {durations: [10], allowedSizes: ['small'], pricing: {}};
  
  // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
  const currentValue = durSel.value;
  
  durSel.innerHTML = '';
  config.durations.forEach((d) => {
    const opt = document.createElement('option');
    opt.value = String(d);
    const cost = config.pricing[d] || 0;
    opt.textContent = `${d}ç§’ (${cost}åˆ†)`;
    durSel.appendChild(opt);
  });
  
  // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼Œæˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼ˆç¬¬ä¸€ä¸ªé€‰é¡¹ï¼‰
  if (currentValue && config.durations.includes(parseInt(currentValue))) {
    durSel.value = currentValue;
  } else {
    durSel.value = String(config.durations[0]);
  }
  
  const allowedSize = config.allowedSizes[0] || 'small';
  sizeSel.value = allowedSize;
  sizeSel.disabled = true;
}

function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹';
  toast.innerHTML = `<span style="font-size:20px;">${icon}</span><span>${message}</span>`;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('hiding');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// åˆå§‹åŒ–
(async function init() {
  try {
    const resp = await fetch('/api/me');
    const json = await resp.json();
    if (json.ok) {
      currentUser = json.data;
      showApp();
    } else {
      showLogin();
    }
  } catch {
    showLogin();
  }
  updateDurationOptions();
  const modelSel = document.getElementById('model');
  if (modelSel) modelSel.addEventListener('change', updateDurationOptions);
})();

function showLogin() {
  document.getElementById('login-container').classList.remove('hidden');
  document.getElementById('app-container').classList.add('hidden');
}

function showApp() {
  document.getElementById('login-container').classList.add('hidden');
  document.getElementById('app-container').classList.remove('hidden');
  document.getElementById('user-display').textContent = `ğŸ‘¤ ${currentUser.username}`;
  document.getElementById('user-credits').textContent = `ğŸ’ ä½™é¢ï¼š${currentUser.credits ?? 0}`;
  loadBatches();
  
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  autoRefreshInterval = setInterval(() => {
    loadBatches(true); // é™é»˜åˆ·æ–°
  }, 5000);
}

async function handleLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const errorEl = document.getElementById('login-error');
  
  errorEl.style.display = 'none';
  
  if (!username || !password) {
    errorEl.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
    errorEl.style.display = 'block';
    return;
  }
  
  try {
    const resp = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const json = await resp.json();
    
    if (json.ok) {
      const meResp = await fetch('/api/me');
      const meJson = await meResp.json();
      if (meJson.ok) {
        currentUser = meJson.data;
      } else {
        currentUser = json.data;
      }
      showApp();
    } else {
      errorEl.textContent = json.error.message || 'ç™»å½•å¤±è´¥';
      errorEl.style.display = 'block';
    }
  } catch (err) {
    errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
    errorEl.style.display = 'block';
  }
}

async function handleLogout() {
  await fetch('/api/logout', { method: 'POST' });
  currentUser = null;
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  showLogin();
}

// å›¾ç‰‡ä¸Šä¼ 
document.getElementById('image-file').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const formData = new FormData();
  formData.append('file', file);
  
  const resp = await fetch('/api/images/upload', { method: 'POST', body: formData });
  const json = await resp.json();
  
  if (json.ok) {
    uploadedImagePath = json.data.path;
    const thumb = document.getElementById('thumb');
    const removeBtn = document.getElementById('remove-img');
    thumb.src = URL.createObjectURL(file);
    thumb.style.display = 'block';
    removeBtn.style.display = 'block';
    showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
  } else {
    showToast(json.error.message, 'error');
  }
});

document.getElementById('remove-img').addEventListener('click', async () => {
  if (!uploadedImagePath) return;
  
  const resp = await fetch('/api/images?image_path=' + encodeURIComponent(uploadedImagePath), { method: 'DELETE' });
  const json = await resp.json();
  
  if (json.ok) {
    uploadedImagePath = null;
    document.getElementById('thumb').style.display = 'none';
    document.getElementById('remove-img').style.display = 'none';
    document.getElementById('image-file').value = '';
    showToast('å›¾ç‰‡å·²åˆ é™¤', 'success');
  }
});

// åˆ›å»ºæ‰¹æ¬¡
async function createBatch() {
  const prompt = document.getElementById('prompt').value.trim();
  if (!prompt) {
    showToast('è¯·è¾“å…¥æç¤ºè¯', 'error');
    return;
  }
  
  const req = {
    prompt,
    model: document.getElementById('model').value,
    orientation: document.getElementById('orientation').value,
    size: document.getElementById('size').value,
    duration: parseInt(document.getElementById('duration').value),
    num_videos: parseInt(document.getElementById('num-videos').value),
    image_path: uploadedImagePath
  };
  
  const idempotencyKey = `${Date.now()}-${Math.random()}`;
  const resp = await fetch('/api/batches', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Idempotency-Key': idempotencyKey
    },
    body: JSON.stringify(req)
  });
  const json = await resp.json();
  
  if (json.ok) {
    showToast('æ‰¹æ¬¡åˆ›å»ºæˆåŠŸ', 'success');
    loadBatches();
    
    // åˆ·æ–°ç§¯åˆ†
    const meResp = await fetch('/api/me');
    const meJson = await meResp.json();
    if (meJson.ok) {
      currentUser = meJson.data;
      document.getElementById('user-credits').textContent = `ğŸ’ ä½™é¢ï¼š${currentUser.credits ?? 0}`;
    }
  } else {
    if (json.error && json.error.code === 'INSUFFICIENT_CREDITS') {
      showToast('ç§¯åˆ†ä¸è¶³ï¼Œè¯·å……å€¼', 'error');
    } else {
      showToast(json.error?.message || 'åˆ›å»ºå¤±è´¥', 'error');
    }
  }
}

// åŠ è½½æ‰¹æ¬¡åˆ—è¡¨
async function loadBatches(silent = false) {
  const resp = await fetch(`/api/batches?page=${currentPage}&page_size=${PAGE_SIZE}`);
  const json = await resp.json();
  
  if (!json.ok) return;
  
  const data = json.data;
  totalPages = data.total_pages || 1;
  document.getElementById('page-info').textContent = `ç¬¬ ${data.page} / ${totalPages} é¡µ`;
  
  const tbody = document.querySelector('#batch-table tbody');
  
  // ä¿å­˜å½“å‰å±•å¼€çŠ¶æ€
  const currentExpanded = new Set(expandedBatches);
  tbody.innerHTML = '';
  
  data.items.forEach((batch, index) => {
    const isExpanded = currentExpanded.has(batch.id);
    
    // ä¸€çº§è¡Œï¼šæ‰¹æ¬¡ä¿¡æ¯
    const tr = document.createElement('tr');
    tr.className = 'batch-row' + (isExpanded ? ' expanded' : '');
    tr.dataset.batchId = batch.id;
    
    // çŠ¶æ€æ ‡ç­¾
    let statusLabel = '';
    let statusColor = '#718096';
    if (batch.running > 0 || batch.queued > 0) {
      statusLabel = 'ğŸ”„ è¿›è¡Œä¸­';
      statusColor = '#3182ce';
    } else if (batch.failed > 0) {
      statusLabel = 'âŒ éƒ¨åˆ†å¤±è´¥';
      statusColor = '#e53e3e';
    } else if (batch.completed === batch.total && batch.total > 0) {
      statusLabel = 'âœ… å…¨éƒ¨å®Œæˆ';
      statusColor = '#38a169';
    } else {
      statusLabel = 'â¸ å¾…å¯åŠ¨';
    }
    
    // æç¤ºè¯é¢„è§ˆ - ä¿®æ”¹5: æ·»åŠ titleæ˜¾ç¤ºå…¨æ–‡
    const promptPreview = batch.prompt.length > 50 ? batch.prompt.substring(0, 50) + '...' : batch.prompt;
    
    // å›¾ç‰‡ç¼©ç•¥å›¾
    let imgHtml = '<span style="color:#a0aec0;">-</span>';
    if (batch.image_path) {
      imgHtml = `<img src="/uploads/${batch.image_path}" class="thumb-small" alt="å›¾ç‰‡" />`;
    }
    
    // åˆ›å»ºæ—¶é—´æ ¼å¼åŒ– - ä¿®æ”¹2: yyyy/mm/dd hh:mm:ss
    const date = new Date(batch.created_at);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hour = String(date.getHours()).padStart(2, '0');
    const minute = String(date.getMinutes()).padStart(2, '0');
    const second = String(date.getSeconds()).padStart(2, '0');
    const createdAt = `${year}/${month}/${day} ${hour}:${minute}:${second}`;
    
    tr.innerHTML = `
      <td>${(currentPage - 1) * PAGE_SIZE + index + 1}</td>
      <td>${createdAt}</td>
      <td><div class="prompt-preview" title="${batch.prompt.replace(/"/g, '&quot;')}">${promptPreview.replace(/</g, '&lt;')}</div></td>
      <td style="text-align:center;">${imgHtml}</td>
      <td>
        <span style="color:${statusColor};font-weight:600;">${statusLabel}</span><br>
        <small style="color:#718096;">æ€»:${batch.total} å®Œæˆ:${batch.completed} å¤±è´¥:${batch.failed}</small>
      </td>
      <td>
        <div class="action-buttons">
          <button class="secondary" onclick="toggleBatchDetail('${batch.id}', event)">
            <span class="expand-icon ${isExpanded ? 'expanded' : ''}">â–¶</span>${isExpanded ? 'æ”¶èµ·' : 'æŸ¥çœ‹'}
          </button>
          <button onclick="refillForm('${batch.id}', event)">å†æ¥ä¸€æ‰¹</button>
          <button class="danger" onclick="deleteBatch('${batch.id}', event)">åˆ é™¤</button>
        </div>
      </td>
    `;
    // ä¿®æ”¹4: ç‚¹å‡»è¡Œå±•å¼€/æ”¶èµ·
    tr.addEventListener('click', (e) => {
      // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è§¦å‘è¡Œç‚¹å‡»
      if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
        return;
      }
      toggleBatchDetail(batch.id, e);
    });
    
    tbody.appendChild(tr);
    
    // å¦‚æœå·²å±•å¼€ï¼Œæ’å…¥äºŒçº§è¡¨æ ¼
    if (isExpanded) {
      insertTasksDetail(tbody, batch.id);
    }
  });
  
  if (!silent && data.items.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#718096;padding:40px;">æš‚æ— æ‰¹æ¬¡</td></tr>';
  }
}

// å±•å¼€/æ”¶èµ·æ‰¹æ¬¡è¯¦æƒ…
async function toggleBatchDetail(batchId, event) {
  event.stopPropagation();
  
  const row = document.querySelector(`tr[data-batch-id="${batchId}"]`);
  const isExpanded = expandedBatches.has(batchId);
  
  if (isExpanded) {
    // æ”¶èµ·
    expandedBatches.delete(batchId);
    row.classList.remove('expanded');
    const detailRow = row.nextElementSibling;
    if (detailRow && detailRow.classList.contains('tasks-detail-row')) {
      detailRow.remove();
    }
    
    // æ›´æ–°æŒ‰é’®æ–‡å­— - ä¿®æ”¹7: ä¿®å¤æ–‡æœ¬æ›´æ–°
    const btn = row.querySelector('button.secondary');
    if (btn) {
      const icon = btn.querySelector('.expand-icon');
      if (icon) icon.classList.remove('expanded');
      // ä½¿ç”¨innerHTMLè€Œä¸æ˜¯childNodesæ¥æ›´æ–°æ•´ä¸ªæŒ‰é’®å†…å®¹
      btn.innerHTML = '<span class="expand-icon">â–¶</span>æŸ¥çœ‹';
    }
  } else {
    // å±•å¼€
    expandedBatches.add(batchId);
    row.classList.add('expanded');
    await insertTasksDetail(row.parentElement, batchId, row);
    
    // æ›´æ–°æŒ‰é’®æ–‡å­— - ä¿®æ”¹7: ä¿®å¤æ–‡æœ¬æ›´æ–°
    const btn = row.querySelector('button.secondary');
    if (btn) {
      const icon = btn.querySelector('.expand-icon');
      if (icon) icon.classList.add('expanded');
      btn.innerHTML = '<span class="expand-icon expanded">â–¶</span>æ”¶èµ·';
    }
  }
}

// æ’å…¥ä»»åŠ¡è¯¦æƒ…äºŒçº§è¡¨æ ¼
async function insertTasksDetail(tbody, batchId, afterRow = null) {
  const resp = await fetch(`/api/batches/${batchId}/tasks`);
  const json = await resp.json();
  
  if (!json.ok) {
    showToast('åŠ è½½ä»»åŠ¡å¤±è´¥', 'error');
    return;
  }
  
  const detailRow = document.createElement('tr');
  detailRow.className = 'tasks-detail-row';
  detailRow.innerHTML = `
    <td colspan="6" class="tasks-detail-cell">
      <div class="tasks-inner-container">
        <div class="tasks-actions">
          <button onclick="retryFailedTasks('${batchId}', event)">é‡è¯•å¤±è´¥</button>
          <button onclick="downloadBatchZip('${batchId}', event)">ä¸€é”®ä¸‹è½½</button>
        </div>
        <table class="tasks-table">
          <thead>
            <tr>
              <th style="width:60px;">åºå·</th>
              <th style="width:120px;">çŠ¶æ€</th>
              <th>ç»“æœ</th>
              <th style="width:200px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tasks-tbody-${batchId}"></tbody>
        </table>
      </div>
    </td>
  `;
  
  if (afterRow) {
    afterRow.after(detailRow);
  } else {
    // æŸ¥æ‰¾æ‰¹æ¬¡è¡Œ
    const batchRow = tbody.querySelector(`tr[data-batch-id="${batchId}"]`);
    if (batchRow) {
      batchRow.after(detailRow);
    } else {
      tbody.appendChild(detailRow);
    }
  }
  
  // å¡«å……ä»»åŠ¡æ•°æ®
  const tasksTbody = document.getElementById(`tasks-tbody-${batchId}`);
  json.data.forEach((task, idx) => {
    const tr = document.createElement('tr');
    const statusClass = `status-${task.status}`;
    const statusText = statusLabels[task.status] || task.status;
    
    let resultCell = '-';
    if (task.status === 'completed' && task.result_path) {
      resultCell = `<a href="${task.result_path}" target="_blank" style="color:#667eea;text-decoration:underline;">æŸ¥çœ‹è§†é¢‘</a>`;
    } else if (task.error_summary) {
      resultCell = `<span style="color:#e53e3e;font-size:12px;">${task.error_summary}</span>`;
    }
    
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td class="${statusClass}">${statusText}</td>
      <td>${resultCell}</td>
      <td>
        ${task.status === 'completed' && task.result_path ? `<button onclick="downloadVideo('${task.result_path}', event)">ä¸‹è½½</button>` : ''}
        ${task.status === 'failed' ? `<button onclick="retryTask('${task.id}', '${batchId}', event)">é‡æ–°ç”Ÿæˆ</button>` : ''}
        <button class="secondary" onclick="deleteTask('${task.id}', '${batchId}', event)">åˆ é™¤</button>
      </td>
    `;
    tasksTbody.appendChild(tr);
  });
  
  if (json.data.length === 0) {
    tasksTbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#718096;padding:20px;">æš‚æ— ä»»åŠ¡</td></tr>';
  }
}

// å†æ¥ä¸€æ‰¹ï¼šå›å¡«è¡¨å•
async function refillForm(batchId, event) {
  event.stopPropagation();
  
  const resp = await fetch(`/api/batches?page=1&page_size=100`);
  const json = await resp.json();
  
  if (!json.ok) return;
  
  const batch = json.data.items.find(b => b.id === batchId);
  if (!batch) return;
  
  // å›å¡«æ•°æ®
  document.getElementById('prompt').value = batch.prompt;
  document.getElementById('model').value = batch.model;
  document.getElementById('orientation').value = batch.orientation;
  document.getElementById('size').value = batch.size;
  document.getElementById('num-videos').value = batch.num_videos;
  
  // æ›´æ–°æ—¶é•¿é€‰é¡¹
  updateDurationOptions();
  document.getElementById('duration').value = batch.duration;
  
  // å›¾ç‰‡å¤„ç†
  if (batch.image_path) {
    uploadedImagePath = batch.image_path;
    const thumb = document.getElementById('thumb');
    const removeBtn = document.getElementById('remove-img');
    thumb.src = `/uploads/${batch.image_path}`;
    thumb.style.display = 'block';
    removeBtn.style.display = 'block';
  }
  
  // æ»šåŠ¨åˆ°é¡¶éƒ¨
  window.scrollTo({ top: 0, behavior: 'smooth' });
  showToast('å‚æ•°å·²å›å¡«ï¼Œå¯ä¿®æ”¹åé‡æ–°ç”Ÿæˆ', 'info');
}

// åˆ é™¤æ‰¹æ¬¡
async function deleteBatch(batchId, event) {
  event.stopPropagation();
  
  if (!confirm('ç¡®è®¤åˆ é™¤æ•´ä¸ªæ‰¹æ¬¡ï¼Ÿ')) return;
  
  const resp = await fetch(`/api/batches/${batchId}`, { method: 'DELETE' });
  const json = await resp.json();
  
  if (json.ok) {
    showToast('æ‰¹æ¬¡å·²åˆ é™¤', 'success');
    expandedBatches.delete(batchId);
    loadBatches();
  } else {
    showToast('åˆ é™¤å¤±è´¥', 'error');
  }
}

// é‡è¯•å¤±è´¥ä»»åŠ¡
async function retryFailedTasks(batchId, event) {
  event.stopPropagation();
  
  const resp = await fetch(`/api/batches/${batchId}/tasks`);
  const json = await resp.json();
  
  if (!json.ok) return;
  
  const failedTasks = json.data.filter(t => t.status === 'failed');
  if (failedTasks.length === 0) {
    showToast('æ²¡æœ‰å¤±è´¥çš„ä»»åŠ¡', 'info');
    return;
  }
  
  for (const task of failedTasks) {
    await fetch(`/api/tasks/${task.id}/retry`, { method: 'POST' });
  }
  
  showToast(`å·²é‡è¯• ${failedTasks.length} ä¸ªå¤±è´¥ä»»åŠ¡`, 'success');
  
  // åˆ·æ–°è¯¥æ‰¹æ¬¡çš„ä»»åŠ¡è¯¦æƒ…
  setTimeout(() => {
    const row = document.querySelector(`tr[data-batch-id="${batchId}"]`);
    if (row && expandedBatches.has(batchId)) {
      const detailRow = row.nextElementSibling;
      if (detailRow) detailRow.remove();
      insertTasksDetail(row.parentElement, batchId, row);
    }
  }, 500);
}

// ä¸€é”®ä¸‹è½½
function downloadBatchZip(batchId, event) {
  event.stopPropagation();
  window.location.href = `/api/batches/${batchId}/download`;
}

// ä¸‹è½½å•ä¸ªè§†é¢‘
function downloadVideo(url, event) {
  event.stopPropagation();
  window.open(url, '_blank');
}

// é‡è¯•å•ä¸ªä»»åŠ¡
async function retryTask(taskId, batchId, event) {
  event.stopPropagation();
  
  const resp = await fetch(`/api/tasks/${taskId}/retry`, { method: 'POST' });
  const json = await resp.json();
  
  if (json.ok) {
    showToast('ä»»åŠ¡å·²é‡æ–°æäº¤', 'success');
    
    // åˆ·æ–°è¯¥æ‰¹æ¬¡çš„ä»»åŠ¡è¯¦æƒ…
    setTimeout(() => {
      const row = document.querySelector(`tr[data-batch-id="${batchId}"]`);
      if (row && expandedBatches.has(batchId)) {
        const detailRow = row.nextElementSibling;
        if (detailRow) detailRow.remove();
        insertTasksDetail(row.parentElement, batchId, row);
      }
    }, 500);
  } else {
    showToast(json.error.message || 'é‡è¯•å¤±è´¥', 'error');
  }
}

// åˆ é™¤å•ä¸ªä»»åŠ¡
async function deleteTask(taskId, batchId, event) {
  event.stopPropagation();
  
  if (!confirm('ç¡®è®¤åˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ')) return;
  
  const resp = await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
  const json = await resp.json();
  
  if (json.ok) {
    showToast('ä»»åŠ¡å·²åˆ é™¤', 'success');
    loadBatches();
    
    // åˆ·æ–°è¯¥æ‰¹æ¬¡çš„ä»»åŠ¡è¯¦æƒ…
    if (expandedBatches.has(batchId)) {
      setTimeout(() => {
        const row = document.querySelector(`tr[data-batch-id="${batchId}"]`);
        if (row) {
          const detailRow = row.nextElementSibling;
          if (detailRow) detailRow.remove();
          insertTasksDetail(row.parentElement, batchId, row);
        }
      }, 500);
    }
  }
}

// åˆ†é¡µ
function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    loadBatches();
  }
}

function nextPage() {
  if (currentPage < totalPages) {
    currentPage++;
    loadBatches();
  }
}
</script>

</body>
</html>
